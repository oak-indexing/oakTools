<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Index Management</title>
    <link rel="stylesheet" href="simplified.css">
    
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-button">&lt;</a>
        <h1>Simplified Index Management</h1>
    </div>

    <div class="container">
        <div class="panel">
            <h2>Overview</h2>
            <p>Note: this feature is currently in Beta mode.
            </p><p>
                Simplified Index Management simple way to define custom indexes and customize
                out-of-the-box (OOTB) indexes, using one JSON file.
                There is no need to copy definitions, or to explicitly define versions.
                Customizations of index definitions are automatically merged with the latest out-of-the-box index, 
                and if needed, a new index version is automatically created.
            </p><p>
                Indexes created using simplified index management 
                have a property "mergeInfo" that links here.
                For more information about indexing, see: 
                <a href="https://experienceleague.adobe.com/en/docs/experience-manager-cloud-service/content/operations/indexing" target="_blank">Content Search and Indexing</a>.
            </p>

            <h2>Run Modes</h2>
            <p>There are two modes of operation.
                While the diff.json file is the same in both modes,
                the configuration and usage of simplified index management is slightly different.
            </p>
            <table class="mode-selector">
                <tr>
                    <td class="mode-tab active" id="immediateTab" onclick="switchMode('immediate')">
                        Immediate Mode
                    </td>
                    <td class="mode-tab" id="pipelineTab" onclick="switchMode('pipeline')">
                        Pipeline Mode
                    </td>
                </tr>
            </table>
            <div id="immediateContent" class="mode-content">
                <h3>Immediate Mode</h3>
                <p>This is used when running AEM locally, 
                    or when using RDE (Rapid Development Environments) for AEM Cloud Service, without pipeline.
                    In this mode, the changes are applied immediately, and the pipeline is not used.
                </p>
                <p>
                    Changes in CRX/DE to the diff.index / diff.json file 
                    immediately create a new version of the respective index, 
                    and immediately reindexing starts in the environment.
                </p>
                <div class="notice-box">
                    <div class="notice-inner">
                        <div class="notice-title">
                            <span class="notice-icon">â“˜</span> Notice
                        </div>
                        <div class="notice-content">
                            If the respository is large, reindexing can take some time. 
                            Do not use this mode for large repositories.
                        </div>
                    </div>
                </div>
                <h3>Configuration</h3>
                <p><ul>
                    <li>Open CRX/DE.
                    <li>Navigate to the path /oak:index.
                    <li>Create a new node named "diff.index" of type "oak:QueryIndexDefinition".
                    <li>Then set the property "type" to "disabled".
                    <li>Create a new node named "diff.json" of type "nt:file".
                    <li>Copy the content of the diff index into this file.
                    <li>Save the changes.
                    <li>Wait a few seconds, and refresh.
                    <li>You should see a new version of the respective index that was created.
                    </li>  
                </p>
            </div>
            <div id="pipelineContent" class="mode-content" style="display: none;">
                <h3>Pipeline Mode</h3>
                <p>This is used for cloud service, for Dev, State, and Prod environments with a pipeline.</p>

                <h3>Configuration</h3>
                <p>
                    In the Git repository of your program, 
                    in the directory <code>ui.apps/src/main/content/jcr_root/_oak_index</code>,
                    create a new directory named <code>diff.index</code>.
                    Inside it, create a new file called <code>.content.xml</code>,
                    with the following content. You will not need to change this file later.
                    It is needed currently for compatibility with the existing tooling.
    <pre>
    &lt;?xml version="1.0" encoding="UTF-8"?>&lt;jcr:root
        xmlns:jcr="http://www.jcp.org/jcr/1.0"
        xmlns:nt="http://www.jcp.org/jcr/nt/1.0"
        jcr:primaryType="nt:unstructured"
        type="lucene" includedPaths="/same" queryPaths="/same">
    &lt;diff.json jcr:primaryType="nt:file"/>&lt;/jcr:root>
    </pre>
                    Then create a new file called <code>diff.json</code> in the same directory.
                    Copy the content of the diff index into this file.
                    Also, in the file <code>/ui.apps/src/main/content/META-INF/vault/filter.xml</code>,
                    add the following line:
    <pre>
        &lt;filter root="/oak:index/diff.index" />
    </pre>
                </p>
                <h3>Deploy the Diff Index</h3>
                <p>
                    Run the pipeline to deploy the diff index.
                    This will merge the diff index with the latest out-of-the-box index,
                    and if needed, a new version is automatically created.
                </p> 
            </div>
            <p></p>

        
            
            <h2>Tools</h2>
            <p>
                <ul>
                    <li><a href="indexDefAnalyzer.html" style="color: #007cba; text-decoration: none;">Index Definition Analyzer</a>:    
                        create a diff index from existing indexes.</li>
                    <li><a href="diffIndexVerifier.html" style="color: #007cba; text-decoration: none;">Diff Index Verifier</a>:    
                        verifies the correctness of the diff index.</li>
                </ul>
            </p>
            <h2>Step by Step Migration Guide</h2>
            <p>
                This guide assumes you already have an AEM as a Cloud Service program
                with custom or customized indexes.
            </p>
            <h3>Create the Diff Index</h3>
            <p>
                To create the diff index, open the AEM as a Cloud Service "Developer Console".
                Select "Status Dump": "Oak Indexes", and "Output Format": "JSON". 
                Click "Get Status", and then click on the "Download" button at the top right.
                This will open the raw JSON file in a new tab.
                Select the whole content, and copy it to the clipboard.
                Then open the <a href="indexDefAnalyzer.html">Index Definition Analyzer</a>.
                and paste the content into the "Index Definitions (JSON)" textarea.
                Click "Analyze".
                On the right side, you will get the diff index.
                Verify it contains the changes you want to apply.
                If you manually changed the diff index, 
                you can verify it by opening the <a href="diffIndexVerifier.html">Diff Index Verifier</a>.
            </p>
            <h3>Example diff.json File</h3>
            <p>
                The following is an example of a diff.json file.
                It contains a customization for the damAssetLucene index,
                and a fully custom index named "custom.slingFolderNodeNames".
                For fully custom indexes, the name needs to contain a dot.
                The index name does not contains the "/oak:index/" prefix.
                Also, fully custom indexes need to have an "includedPaths" property that is not empty,
                and set to a path that doesn't include "/apps" or "/libs". It is best to set the "queryPaths"
                to the same value as the "includedPaths".
<pre>
{
    "damAssetLucene": {
        "indexRules": {
            "dam:Asset": {
                "properties": {
                    "test1": {
                        "name": "test",
                        "propertyIndex": true
                    }
                }
            }
        }
    },
    "custom.slingFolderNodeNames": {
        "async": [ "async" ],
        "compatVersion": 2,
        "evaluatePathRestrictions": true,
        "includedPaths": [ "/content/dam" ],
        "queryPaths": [ "/content/dam" ],
        "type": "lucene",
        "indexRules": {
            "sling:Folder": {
                "indexNodeName": true
            }
        }
    }
}
</pre>
        </div>
    </div>

    <script>
        function switchMode(mode) {
            // Hide all content
            document.getElementById('immediateContent').style.display = 'none';
            document.getElementById('pipelineContent').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('immediateTab').classList.remove('active');
            document.getElementById('pipelineTab').classList.remove('active');
            
            // Show selected content and activate tab
            if (mode === 'immediate') {
                document.getElementById('immediateContent').style.display = 'block';
                document.getElementById('immediateTab').classList.add('active');
            } else if (mode === 'pipeline') {
                document.getElementById('pipelineContent').style.display = 'block';
                document.getElementById('pipelineTab').classList.add('active');
            }
        }
    </script>

</body>
</html>


